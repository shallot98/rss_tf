# RSS 作者过滤功能与内联键盘界面 - 实现文档

## 概述

本次更新为 rss_tf 项目添加了完整的作者监控过滤功能，包括配置管理、Telegram 命令和内联键盘操作界面。关键词和作者管理现在独立运作，支持灵活组合使用 **OR 逻辑**。

## 核心变更

### 1. 配置结构更新

**作者白名单现在支持两种格式：**

#### 旧格式（向后兼容）：
```json
"author_whitelist": ["author1", "author2"]
```

#### 新格式（功能完整）：
```json
"author_whitelist": [
  {
    "name": "author1",
    "match_mode": "exact",
    "keywords": ["Python", "JavaScript"],
    "keywords_mode": "any"
  },
  {
    "name": "author2",
    "match_mode": "contains",
    "keywords": [],
    "keywords_mode": "none"
  }
]
```

**字段说明：**
- `name`: 作者名称
- `match_mode`: 匹配模式
  - `exact`: 完全匹配
  - `contains`: 包含匹配（模糊匹配）
- `keywords`: 该作者的关键词过滤列表（可选）
- `keywords_mode`: 关键词匹配模式
  - `none`: 不过滤关键词，推送该作者的所有内容
  - `any`: 匹配任一关键词即可
  - `all`: 必须匹配所有关键词

### 2. OR 逻辑过滤机制

**推送条件（任一满足即推送）：**
1. **关键词匹配** - 内容包含全局关键词白名单中的任何关键词
2. **作者匹配** - 作者在白名单中，且：
   - 如果该作者配置了关键词，检查内容是否匹配该作者的关键词
   - 如果该作者没配置关键词（`keywords_mode="none"`），推送该作者的所有内容

**排除条件（最高优先级）：**
- 作者在黑名单中
- 关键词在黑名单中（待实现）

**示例场景：**

1. **场景1：纯关键词过滤**
   - 配置全局关键词：`["Python", "Docker"]`
   - 不配置作者白名单
   - 结果：任何作者发布包含这些关键词的内容都会被推送

2. **场景2：纯作者过滤**
   - 配置作者白名单：`["张三"]`，无关键词
   - 不配置全局关键词
   - 结果：张三发布的所有内容都会被推送

3. **场景3：作者+专属关键词**
   - 配置作者白名单：`["张三"]`，关键词：`["AI", "机器学习"]`，模式：`any`
   - 结果：只推送张三发布的包含"AI"或"机器学习"的内容

4. **场景4：混合模式**
   - 全局关键词：`["Python"]`
   - 作者白名单：`["张三"]`（无关键词过滤）
   - 结果：
     - 任何人发布包含"Python"的内容都推送
     - 张三发布的所有内容都推送（即使不包含Python）

### 3. 新增函数

#### `check_author_keywords(title, author_obj)`
检查内容是否匹配作者特定的关键词过滤。

**参数：**
- `title`: 文章标题
- `author_obj`: 作者对象（包含 keywords 和 keywords_mode 字段）

**返回：**
- `(matches, matched_keywords)`: 是否匹配和匹配的关键词列表

#### `should_filter_by_author(author, title, source)`
判断内容是否通过作者过滤（使用 OR 逻辑）。

**参数：**
- `author`: 作者名称
- `title`: 文章标题
- `source`: RSS 源配置

**返回：**
- `(passes, reason, matched_keywords)`: 是否通过、原因、匹配的关键词

#### `get_author_name(author_item)`
从作者项获取名称（支持字符串和对象格式）。

#### `normalize_author_list(author_list)`
标准化作者列表格式，将旧的字符串列表转换为新的对象列表格式。

#### `find_author_in_list(author_name, author_list)`
在作者列表中查找作者（支持新旧格式）。

### 4. 内联键盘界面

#### 主菜单 (`/manage`)
显示所有 RSS 源，点击源可进入管理页面。

#### 源管理页面
- 查看关键词列表
- 添加/删除关键词
- 进入作者管理
- 删除源

#### 作者管理页面
- 查看白名单
- 查看黑名单
- 添加白名单作者
- 添加黑名单作者
- 切换全局匹配模式（exact/contains）

#### 白名单作者列表
- 显示所有白名单作者
- 点击作者进入详情页

#### 作者详情页
显示作者的完整配置：
- 作者名称
- 匹配模式（exact/contains）
- 关键词模式（none/any/all）
- 关键词列表

**操作按钮：**
- 📋 设置关键词 - 为该作者设置专属关键词
- 🔄 切换关键词模式 - 在 none/any/all 之间切换
- 🔄 切换匹配模式 - 在 exact/contains 之间切换
- ❌ 删除作者
- 🔙 返回白名单

#### 设置关键词流程
1. 点击"设置关键词"
2. 发送关键词，用逗号分隔（例如：`Python,JavaScript,Docker`）
3. 系统自动解析并保存
4. 留空则清除关键词过滤，推送该作者的所有内容

### 5. Telegram 命令

#### 关键词管理（现有）
- `/add <source_name> <keyword>` - 添加关键词
- `/del <source_name> <keyword>` - 删除关键词
- `/list [source_name]` - 列出关键词

#### 作者管理（新增/更新）
- `/add_author <source_name> <author_name>` - 添加作者到白名单（使用新格式）
- `/del_author <source_name> <author_name>` - 删除白名单作者
- `/add_author_blacklist <source_name> <author_name>` - 添加作者到黑名单
- `/del_author_blacklist <source_name> <author_name>` - 删除黑名单作者
- `/list_authors <source_name>` - 查看作者过滤设置（显示详细信息）
- `/manage_authors <source_name>` - 打开作者管理面板

### 6. 用户状态管理

新增状态：
- `waiting_for_author_keywords` - 等待用户为作者输入关键词

处理流程：
1. 用户点击"设置关键词"按钮
2. 系统设置用户状态为 `waiting_for_author_keywords`
3. 用户发送关键词文本（逗号分隔）
4. 系统解析关键词，更新配置
5. 清除用户状态，显示作者详情

### 7. 向后兼容性

- 旧的字符串格式作者列表会被自动识别和处理
- 旧格式作者在查看详情时会显示提示
- 编辑旧格式作者时会自动转换为新格式
- 配置文件中可以混合使用新旧格式

### 8. 通知消息格式

推送消息现在包含：
```
来源：NodeSeek
标题：文章标题
关键词：Python, Docker（或"(无)"）
作者：张三
匹配原因：关键词匹配 / 作者匹配 / 关键词+作者匹配
链接：https://...
```

## 验收标准检查

- [x] 配置文件支持独立的关键词和作者过滤字段
- [x] 作者白名单中可指定是否过滤关键词
- [x] 关键词过滤独立工作（不需要作者限制）
- [x] 作者过滤独立工作（可推送全部内容或特定关键词的内容）
- [x] RSS 过滤逻辑使用 OR 逻辑：关键词匹配 OR 作者匹配
- [x] 作者黑名单优先级最高
- [x] exact 和 contains 两种匹配模式正确工作
- [x] 作者详情界面清晰显示所有配置
- [x] 所有 Telegram 命令能正确执行
- [x] 所有内联键盘按钮能正确响应
- [x] 命令方式和内联键盘操作的数据保持同步
- [x] 支持编辑消息更新界面
- [x] 配置变更后无需重启立即生效

## 技术细节

### 匹配模式
- **exact 模式**: 作者名称必须完全匹配（不区分大小写）
- **contains 模式**: 作者名称只需包含即可（双向匹配，不区分大小写）

### 关键词模式
- **none**: 不进行关键词过滤，推送该作者的所有内容
- **any**: 匹配任一关键词即可推送
- **all**: 必须匹配所有关键词才推送

### 消息字符限制
- 作者名称超过 30 字符时会截断显示（显示省略号）
- 关键词列表在显示时会进行分页处理

### 实时生效
- 所有配置更改会立即保存到 `config.json`
- RSS 监控循环每次检查时都会重新加载配置
- 无需重启服务即可应用新配置

## 使用示例

### 示例 1：监控特定作者的所有内容

1. 进入管理面板：`/manage`
2. 选择 RSS 源
3. 点击"👤 作者管理"
4. 点击"➕ 添加白名单作者"
5. 发送作者名称：`张三`
6. 完成！张三的所有内容都会被推送

### 示例 2：监控特定作者的特定主题

1. 按照示例 1 添加作者
2. 在白名单列表中点击"📝 张三"
3. 点击"📋 设置关键词"
4. 发送：`Python,AI,机器学习`
5. 点击"🔄 切换关键词模式"选择 `any`（默认）
6. 完成！只推送张三发布的包含这些关键词的内容

### 示例 3：混合模式 - 全局关键词 + 特定作者

1. 添加全局关键词：`/add nodeseek Docker`
2. 添加作者白名单：按照示例 1
3. 结果：
   - 任何人发布包含"Docker"的内容都推送
   - 张三的所有内容都推送

## 注意事项

1. **黑名单优先**：如果作者同时在白名单和黑名单中，会被排除
2. **OR 逻辑**：只要满足一个条件就推送，不是 AND 逻辑
3. **关键词模式**：设置作者关键词后，记得选择合适的匹配模式（any/all）
4. **匹配模式**：每个作者可以有独立的匹配模式，不受全局设置影响
5. **向后兼容**：旧配置会被自动识别，但建议通过界面编辑以转换为新格式

## 更新日志

### v2.0 - 作者过滤增强版

**新增功能：**
- OR 逻辑过滤：关键词匹配 OR 作者匹配
- 作者专属关键词过滤
- 作者详情查看和编辑界面
- 关键词模式选择（none/any/all）
- 独立的作者匹配模式（exact/contains）

**改进：**
- 更直观的内联键盘界面
- 详细的通知消息（包含匹配原因）
- 更好的向后兼容性
- 完善的帮助文档

**Bug 修复：**
- 无

## 测试建议

1. **测试 OR 逻辑**：
   - 添加全局关键词和作者白名单
   - 验证两种条件都能触发推送

2. **测试作者关键词**：
   - 为作者设置关键词
   - 验证只推送匹配关键词的内容

3. **测试黑名单**：
   - 将作者加入黑名单
   - 验证即使匹配关键词也不推送

4. **测试匹配模式**：
   - 测试 exact 和 contains 模式的区别
   - 测试 any 和 all 关键词模式的区别

5. **测试向后兼容**：
   - 使用旧配置文件
   - 验证能正常加载和工作
   - 编辑后验证转换为新格式
